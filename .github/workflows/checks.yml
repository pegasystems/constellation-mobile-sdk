name: "Perform build and checks"
on:
  push
jobs:
  build-android:
    runs-on: 'ubuntu-latest'
    outputs:
      android-apk: 'android/app/build/intermediates/apk/debug/app-debug.apk'
    env:
      GRADLE: ./gradlew -Dorg.gradle.console=plain --info --stacktrace --no-daemon

    steps:
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'corretto'

    - name: Checkout repo
      uses: actions/checkout@v4

    # - name: Setup Android SDK
    #   uses: android-actions/setup-android@v3
    - name: Setup Android SDK
      run: |
        echo "Downloading Android SDK Command Line Tools"
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-12266719_latest.zip

        echo "Unpacking Android SDK Command Line Tools"
        mkdir android-sdk
        unzip commandlinetools-*.zip -d android-sdk

        echo "Accepting licenses"
        (while sleep 3; do echo "y"; done) | ./android-sdk/cmdline-tools/bin/sdkmanager --licenses --sdk_root=./android-sdk/

        echo "Updating and installing required tools"
        ./android-sdk/cmdline-tools/bin/sdkmanager --sdk_root=./android-sdk/ "platforms;android-35" "platform-tools"

    - name: Check tool versions
      run: |
        echo '----- Directory list ----'
        echo "Current dir = ${PWD}"
        ls -lh
        echo '----- Java version ----'
        java -version
        echo '----- ADB version ----'
        ./android-sdk/platform-tools/adb --version

    - name: Android - gradle assemble
      run: |
        export ANDROID_SDK=${PWD}/android_sdk
        cd android
        $GRADLE clean assemble
